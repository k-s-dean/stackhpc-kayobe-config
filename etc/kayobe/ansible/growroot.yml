---
- name: Grow root pv
  hosts: overcloud
  tags:
    - growpart
  vars:
    ansible_user: "{{ bootstrap_user }}"
    # We can't assume that a virtualenv exists at this point, so use the system
    # python interpreter.
    ansible_python_interpreter: /usr/bin/python3
    # Work around no known_hosts entry on first boot.
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"

  tasks:
    - name: Ensure growpart is installed
      package:
        name: "{% if ansible_facts.os_family == 'RedHat' %}cloud-utils-growpart{% else %}cloud-guest-utils{% endif %}"
        state: present
      become: True

    - name: Get root PV device 
      command: "pvs --select vg_name=rootvg --reportformat json"
      register: pvs
      become: True
      changed_when: False

    - name: Grow partition 
      command: "growpart {{ disk }} {{ part_num }}"
      vars:
        pv: "{{ pvs.stdout | from_json }}"
        disk_tmp: "{{ pv.report[0].pv[0].pv_name[:-1] }}"
        disk: "{{ disk_tmp[:-1] if disk_tmp[-1] == 'p' else disk_tmp }}"
        part_num: "{{ pv.report[0].pv[0].pv_name[-1] }}"
      become: True
      failed_when: "growpart.rc != 0 and 'NOCHANGE' not in growpart.stdout"
      changed_when: "'NOCHANGE' not in growpart.stdout"
      register: growpart

    - name: Grow LVM PV
      command: "pvresize {{ disk }}"
      vars:
        pv: "{{ pvs.stdout | from_json }}"
        disk: "{{ pv.report[0].pv[0].pv_name }}"
      become: True
      when: "'NOCHANGE' not in growpart.stdout"
